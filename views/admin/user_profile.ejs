<div class="container profile-page-container" data-user-id="<%= userProfile._id %>">
    <div class="page-header profile-header">
        <div class="profile-info-block">
            <div class="user-avatar header-avatar">
                <% if (userProfile.emojiAvatar) { %>
                    <img src="https://emojicdn.elk.sh/<%= encodeURIComponent(userProfile.emojiAvatar) %>?style=apple" alt="Avatar" class="emoji-avatar-img">
                <% } else { %>
                    <span><%= userProfile.name.charAt(0) %></span>
                <% } %>
            </div>
            <div class="header-title-block">
                <h1><%= userProfile.name %></h1>
                <p class="section-subtitle">User Profile (<%= userProfile.role %>)</p>
            </div>
        </div>

        <div class="page-actions">
            <a href="/dashboard/users/edit/<%= userProfile._id %>" class="btn btn-secondary"><i class="icon-edit"></i> Edit User</a>
            <a href="/dashboard/users" class="btn btn-secondary">Back to All Users</a>
        </div>
    </div>

    <div class="card">
        <div class="page-actions" style="padding: 0; flex-wrap: wrap; gap: 10px;">
            <% if (userProfile.role === 'student') { %>
                <a href="#" id="schedule-lesson-btn" class="btn btn-primary" data-student-id="<%= userProfile._id %>">
                    <i class="icon-add"></i> Schedule Lesson
                </a>
                <button id="adjust-balance-btn" class="btn btn-secondary"><i class="icon-edit"></i> Adjust Balance</button>
            <% } %>
            <button id="reset-password-btn" class="btn btn-secondary"><i class="icon-key"></i> Send Password Reset</button>
        </div>
    </div>

    <div class="stats-grid">
        <div class="stat-card status-card">
            <div class="stat-info">
                <span class="stat-number small">
                    <span class="badge status-<%= userProfile.status %> status-badge">
                        <i class="status-icon"></i>
                        <%= userProfile.status.charAt(0).toUpperCase() + userProfile.status.slice(1) %>
                    </span>
                </span>
                <span class="stat-label">Status</span>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-info">
                <span class="stat-number small"><%= userProfile.email %></span>
                <span class="stat-label">Email</span>
            </div>
        </div>
        <% if (userProfile.role === 'student') { %>
            <div class="stat-card">
                <div class="stat-info">
                    <span class="stat-number"><%= userProfile.stars %></span>
                    <span class="stat-label">Stars Balance</span>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-info">
                    <span class="stat-number"><%= userProfile.lessonsPaid %></span>
                    <span class="stat-label">Paid Lessons</span>
                </div>
            </div>
        <% } %>
    </div>
    
    <% if (userProfile.role === 'student') { %>
        <div class="card">
            <h2>Adjust Balance</h2>
            <div class="tabs">
                <button class="tab-link active" data-tab="stars">Stars</button>
                <button class="tab-link" data-tab="lessons">Paid Lessons</button>
            </div>

            <div id="stars" class="tab-content active">
                <form action="/dashboard/user-profile/<%= userProfile._id %>/adjust-stars" method="POST" class="adjustment-form">
                    <div class="form-group">
                        <label for="starsAdjustment">Stars Adjustment</label>
                        <input type="number" id="starsAdjustment" name="starsAdjustment" placeholder="e.g., 10 or -5" required>
                    </div>
                    <div class="form-group reason-group">
                        <label for="starsAdjustmentReason">Reason for Adjustment</label>
                        <input type="text" id="starsAdjustmentReason" name="adjustmentReason" placeholder="e.g., Bonus for excellent work" required>
                    </div>
                    <div class="form-actions">
                        <button type="submit" class="btn btn-primary">Adjust Stars</button>
                    </div>
                </form>
            </div>

            <div id="lessons" class="tab-content">
                <form action="/dashboard/user-profile/<%= userProfile._id %>/adjust-lessons" method="POST" class="adjustment-form">
                    <div class="form-group">
                        <label for="lessonsAdjustment">Paid Lessons Adjustment</label>
                        <input type="number" id="lessonsAdjustment" name="lessonsAdjustment" placeholder="e.g., 8 or -1" required>
                    </div>
                    <div class="form-group reason-group">
                        <label for="lessonsAdjustmentReason">Reason for Adjustment</label>
                        <input type="text" id="lessonsAdjustmentReason" name="adjustmentReason" placeholder="e.g., Payment received" required>
                    </div>
                    <div class="form-actions">
                        <button type="submit" class="btn btn-primary">Adjust Lessons</button>
                    </div>
                </form>
            </div>
        </div>
    <% } %>

    <div class="card">
        <h2>Lesson History</h2>
        <div class="table-responsive">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th><%= userProfile.role === 'student' ? 'Teacher' : 'Student' %></th>
                        <th>Topic</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <% if (lessons && lessons.length > 0) { %>
                        <% lessons.forEach(lesson => { %>
                            <tr data-lesson-id="<%= lesson._id %>">
                                <td><%= new Date(lesson.localLessonDate).toLocaleString('en-GB', { day: '2-digit', month: 'short', year: 'numeric' }) %></td>
                                <td><%= userProfile.role === 'student' ? (lesson.teacher ? lesson.teacher.name : 'N/A') : (lesson.student ? lesson.student.name : 'N/A') %></td>
                                <td><%= lesson.topic %></td>
                                <td class="status-cell" data-lesson-id="<%= lesson._id %>" data-current-status="<%= lesson.status %>">
                                    <span class="badge status-<%= lesson.status %> current-status-badge"><%= lesson.status.replace(/_/g, ' ') %></span>
                                    <div class="status-dropdown">
                                        <div class="status-dropdown-item" data-status="scheduled">Scheduled</div>
                                        <div class="status-dropdown-item" data-status="completed">Completed</div>
                                        <div class="status-dropdown-item" data-status="cancelled_by_student">Cancelled (Student)</div>
                                        <div class="status-dropdown-item" data-status="cancelled_by_teacher">Cancelled (Teacher)</div>
                                        <div class="status-dropdown-item" data-status="no_show">No Show</div>
                                    </div>
                                </td>
                                <td class="actions-cell">
                                    <button class="btn-icon delete-lesson-btn" data-id="<%= lesson._id %>" data-tooltip="Delete"><i class="icon-delete"></i></button>
                                </td>
                            </tr>
                        <% }); %>
                    <% } else { %>
                        <tr><td colspan="5" style="text-align: center; padding: 20px;">No lesson history found.</td></tr>
                    <% } %>
                </tbody>
            </table>
        </div>
    </div>
    
    <% if (userProfile.balanceHistory && userProfile.balanceHistory.length > 0) { %>
        <div class="card">
            <h2>Balance History</h2>
            <div class="table-responsive">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Details</th>
                            <th>Change</th>
                            <th>Stars After</th>
                            <th>Lessons After</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <% userProfile.balanceHistory.slice().reverse().forEach(entry => { %>
                            <tr>
                                <td><%= new Date(entry.date).toLocaleString('en-GB') %></td>
                                <td>
                                    <%= entry.reason %>
                                    <% if (entry.amountPaid) { %>
                                        <br>
                                        <small>
                                            Amount: <strong><%= entry.amountPaid.toFixed(2) %> <%= entry.currency %></strong> | 
                                            Tariff: <%= entry.transactionType %>
                                        </small>
                                    <% } %>
                                </td>
                                <td>
                                    <span class="badge <%= entry.change > 0 ? 'status-completed' : 'status-cancelled_by_teacher' %>">
                                        <%= entry.change > 0 ? '+' : '' %><%= entry.change %>
                                    </span>
                                </td>
                                <td>
                                    <%= (entry.starsBalanceAfter !== undefined && entry.starsBalanceAfter !== null && !isNaN(entry.starsBalanceAfter)) ? Number(entry.starsBalanceAfter) : 'N/A' %>
                                </td>
                                <td>
                                    <%= (entry.lessonsBalanceAfter !== undefined && entry.lessonsBalanceAfter !== null && !isNaN(entry.lessonsBalanceAfter)) ? Number(entry.lessonsBalanceAfter) : 'N/A' %>
                                </td>
                                <td class="actions-cell">
                                    <form action="/dashboard/users/balance/delete/<%= entry._id %>?userId=<%= userProfile._id %>" method="POST" style="display:inline;">
                                        <button type="submit" class="btn-icon" data-tooltip="Delete" onclick="return confirm('Are you sure you want to delete this entry?');"><i class="icon-delete"></i></button>
                                    </form>
                                </td>
                            </tr>
                        <% }); %>
                    </tbody>
                </table>
            </div>
        </div>
        <% } %>
</div>

<script src="/js/user_profile.js" defer></script>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Find adjustment card by checking h2 text content
        const adjustmentCard = Array.from(document.querySelectorAll('.card')).find(card => {
            const h2 = card.querySelector('h2');
            return h2 && h2.textContent.includes('Adjust Balance');
        });
        
        if (adjustmentCard) {
            adjustmentCard.style.display = 'none';
        }

        const adjustBalanceBtn = document.getElementById('adjust-balance-btn');
        if (adjustBalanceBtn) {
            adjustBalanceBtn.addEventListener('click', function(e) {
                e.preventDefault();
                if (adjustmentCard) {
                    adjustmentCard.style.display = adjustmentCard.style.display === 'none' ? 'block' : 'none';
                }
            });
        }

        // Tab functionality
        const tabs = document.querySelectorAll('.tab-link');
        const tabContents = document.querySelectorAll('.tab-content');

        tabs.forEach(tab => {
            tab.addEventListener('click', function(e) {
                e.preventDefault();
                const targetId = this.dataset.tab;
                const targetContent = document.getElementById(targetId);

                // Remove active class from all tabs and contents
                tabs.forEach(t => t.classList.remove('active'));
                tabContents.forEach(content => content.classList.remove('active'));

                // Add active class to clicked tab and corresponding content
                this.classList.add('active');
                if (targetContent) {
                    targetContent.classList.add('active');
                }
            });
        });
    });
</script>