<div class="page-header">
    <div>
        <h1>Manage Lesson</h1>
        <p class="section-subtitle">With <strong><%= lesson.student.name %></strong> on course <strong>"<%= lesson.course.name %>"</strong></p>
        <p class="lesson-date">Scheduled for: <strong><%= new Date(lesson.localLessonDate).toLocaleString('en-GB', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit' }) %></strong></p>
    </div>
</div>

<div class="card form-card">
    <form action="/dashboard/lessons/manage/<%= lesson._id %>" method="POST" enctype="multipart/form-data">
        
        <div class="form-group">
            <label for="topic">Lesson Topic</label>
            <input type="text" id="topic" name="topic" value="<%= lesson.topic || '' %>" placeholder="What was covered in the lesson?">
        </div>
        
        <div class="form-group">
            <label for="status">Lesson Status</label>
            <select id="status" name="status">
                <option value="scheduled" <%= lesson.status === 'scheduled' ? 'selected' : '' %>>Scheduled</option>
                <option value="completed" <%= lesson.status === 'completed' ? 'selected' : '' %>>Completed</option>
                <option value="cancelled_by_teacher" <%= lesson.status === 'cancelled_by_teacher' ? 'selected' : '' %>>Cancelled (by teacher)</option>
                <option value="cancelled_by_student" <%= lesson.status === 'cancelled_by_student' ? 'selected' : '' %>>Cancelled (by student)</option>
                <option value="no_show" <%= lesson.status === 'no_show' ? 'selected' : '' %>>Student No Show</option>
            </select>
        </div>

        <div class="form-group">
            <label for="homework">Homework</label>
            <textarea id="homework" name="homework" rows="3" placeholder="Describe the homework assignment..."><%= lesson.homework || '' %></textarea>
        </div>
        <div class="form-group">
            <label>Attach File (PDF, DOC, IMG, ZIP)</label>
            <% if (lesson.teacherAttachment && lesson.teacherAttachment.filename) { %>
                <div class="attachment-info">
                    <span><i class="icon-file"></i> <%= lesson.teacherAttachment.filename %></span>
                    <a href="/dashboard/lessons/delete-attachment/<%= lesson._id %>/teacher" class="btn-icon btn-danger" data-tooltip="Delete File" onclick="return confirm('Are you sure?')"><i class="icon-delete"></i></a>
                </div>
            <% } else { %>
                <div class="file-upload-wrapper">
                    <input type="file" name="teacherAttachment" class="file-input">
                    <div class="upload-icon"><i class="icon-upload"></i></div>
                    <div class="upload-text">Drag & Drop or Click to Upload</div>
                    <div class="file-name"></div>
                </div>
            <% } %>
        </div>
        
        <div class="form-group">
            <label for="recordingUrl">Lesson Recording URL</label>
            <input type="url" id="recordingUrl" name="recordingUrl" value="<%= lesson.recordingUrl || '' %>" placeholder="https://zoom.us/rec/...">
        </div>
        
        <div class="form-group">
            <label for="notes">My Private Notes</label>
            <textarea id="notes" name="notes" rows="2" placeholder="Notes only visible to you..."><%= lesson.notes || '' %></textarea>
        </div>
        <div class="form-group">
            <label>Student's Homework</label>
            <% if (lesson.studentAttachment && lesson.studentAttachment.filename) { %>
                <a href="/download/<%= lesson.studentAttachment.path.split('\\').pop().split('/').pop() %>" class="btn btn-secondary">Download Student's HW</a>
            <% } else { %>
                <p>Student has not submitted homework yet.</p>
            <% } %>
        </div>
        <div class="form-group">
            <label for="homeworkStatus">Homework Status</label>
            <select id="homeworkStatus" name="homeworkStatus">
                <option value="pending" <%= lesson.homeworkStatus === 'pending' ? 'selected' : '' %>>Pending</option>
                <option value="submitted" <%= lesson.homeworkStatus === 'submitted' ? 'selected' : '' %>>Submitted</option>
                <option value="checked" <%= lesson.homeworkStatus === 'checked' ? 'selected' : '' %>>Checked</option>
            </select>
        </div>

        <label class="checkbox-label">
            <input type="checkbox" id="isProject" name="isProject" <%= lesson.isProject ? 'checked' : '' %> onchange="toggleProjectFields()">
            <span class="custom-checkbox"><i class="icon-check"></i></span>
            <span>This is a Project Lesson</span>
        </label>

        <div id="project-fields" style="<%= lesson.isProject ? 'display:block;' : 'display:none;' %>">
            <div class="form-group"><label for="projectTitle">Project Title</label><input type="text" name="projectDetails[title]" value="<%= (lesson.projectDetails && lesson.projectDetails.title) ? lesson.projectDetails.title : '' %>"></div>
            <div class="form-group"><label for="projectDesc">Project Description</label><textarea name="projectDetails[description]"><%= (lesson.projectDetails && lesson.projectDetails.description) ? lesson.projectDetails.description : '' %></textarea></div>
            <div class="form-group"><label for="projectRecording">Project Defense Recording URL</label><input type="url" name="projectDefenseRecordingUrl" value="<%= lesson.projectDefenseRecordingUrl || '' %>"></div>
        </div>

        <div class="form-group">
            <label for="score" id="score-label">Grade</label>
            <input type="number" id="score" name="score" min="1" step="1" placeholder="Leave blank if not applicable">
        </div>
        <div class="form-group">
            <label for="comment">Comment on Grade (optional)</label>
            <input type="text" id="comment" name="comment" placeholder="e.g., 'Excellent work with loops!'">
        </div>
        
        <div class="form-actions">
            <button type="submit" class="btn btn-primary">Save Changes</button>
            <a href="<%= user.role === 'admin' ? '/dashboard/lessons' : '/dashboard/schedule' %>" class="btn btn-secondary">Cancel</a>
        </div>
    </form>
</div>

<script>
    function toggleProjectFields() {
        const isProjectCheckbox = document.getElementById('isProject');
        const projectFields = document.getElementById('project-fields');
        const scoreInput = document.getElementById('score');
        const scoreLabel = document.getElementById('score-label');

        if (isProjectCheckbox.checked) {
            projectFields.style.display = 'block';
            scoreInput.max = 25;
            scoreLabel.textContent = 'Grade (1-25)';
        } else {
            projectFields.style.display = 'none';
            scoreInput.max = 10;
            scoreLabel.textContent = 'Grade (1-10)';
        }
    }
    document.addEventListener('DOMContentLoaded', toggleProjectFields);
</script>