<div class="container">
    <div class="page-header">
        <h1>Welcome, <%= user.name.split(' ')[0] %>!</h1>
    </div>

    <div class="stats-grid">
        <% if (user.role === 'student') { %>
            <div class="stat-card">
                <div class="stat-icon" style="--icon-bg: rgba(0, 242, 254, 0.2); --icon-color: var(--accent-color-1);"><i class="icon-list"></i></div>
                <div class="stat-info">
                    <span class="stat-number"><%= stats.lessonsPaid %></span>
                    <span class="stat-label">Lessons Paid</span>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon" style="--icon-bg: rgba(196, 58, 214, 0.2); --icon-color: var(--accent-color-2);"><i class="icon-calendar"></i></div>
                <div class="stat-info">
                    <% if (stats.upcomingLesson) { %>
                        <span class="stat-number small"><%= new Date(stats.upcomingLesson.lessonDate).toLocaleDateString('en-GB', { month: 'short', day: 'numeric' }) %></span>
                        <span class="stat-label">Next Lesson</span>
                    <% } else { %>
                        <span class="stat-number small">--</span>
                        <span class="stat-label">No lessons scheduled</span>
                    <% } %>
                </div>
            </div>
        <% } %>

        <% if (user.role === 'teacher') { %>
            <div class="stat-card">
                <div class="stat-icon" style="--icon-bg: rgba(46, 204, 113, 0.2); --icon-color: #2ecc71;"><i class="icon-calendar"></i></div>
                <div class="stat-info">
                    <span class="stat-number"><%= stats.lessonsThisWeek %></span>
                    <span class="stat-label">Lessons This Week</span>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon" style="--icon-bg: rgba(52, 152, 219, 0.2); --icon-color: #3498db;"><i class="icon-users"></i></div>
                <div class="stat-info">
                    <span class="stat-number"><%= stats.studentCount %></span>
                    <span class="stat-label">Active Students</span>
                </div>
            </div>
        <% } %>

        <% if (user.role === 'admin') { %>
             <div class="stat-card">
                <div class="stat-icon" style="--icon-bg: rgba(52, 152, 219, 0.2); --icon-color: #3498db;"><i class="icon-users"></i></div>
                <div class="stat-info">
                    <span class="stat-number"><%= stats.studentCount %></span>
                    <span class="stat-label">Total Students</span>
                </div>
            </div>
             <div class="stat-card">
                <div class="stat-icon" style="--icon-bg: rgba(155, 89, 182, 0.2); --icon-color: #9b59b6;"><i class="icon-briefcase"></i></div>
                <div class="stat-info">
                    <span class="stat-number"><%= stats.teacherCount %></span>
                    <span class="stat-label">Total Teachers</span>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon" style="--icon-bg: rgba(46, 204, 113, 0.2); --icon-color: #2ecc71;"><i class="icon-list"></i></div>
                <div class="stat-info">
                    <span class="stat-number"><%= stats.lessonsScheduled %></span>
                    <span class="stat-label">Upcoming Lessons</span>
                </div>
            </div>
        <% } %>
    </div>
    
    <div class="card calendar-card">
        <h2>Schedule Overview</h2>
        <div id="calendar" style="min-height: 500px;"></div>
    </div>
    <div id="events-list"></div> 
</div>

<script>
document.addEventListener('DOMContentLoaded', async function() {
    const calendarEl = document.getElementById('calendar');
    const eventsListEl = document.getElementById('events-list');
    let allEvents = [];
    let selectedDateEl = null;

    try {
        const response = await fetch('/api/lessons');
        if (!response.ok) throw new Error('Failed to fetch lessons');
        allEvents = await response.json();
    } catch (error) {
        console.error(error);
        calendarEl.innerHTML = '<p>Could not load schedule.</p>';
        return;
    }

    function getLocalDateString(date) {
        const d = new Date(date);
        const year = d.getFullYear();
        const month = ('0' + (d.getMonth() + 1)).slice(-2);
        const day = ('0' + d.getDate()).slice(-2);
        return `${year}-${month}-${day}`;
    }

    function renderEventsForDate(dateStr) {
        const eventsForDay = allEvents.filter(event => getLocalDateString(event.start) === dateStr);
        if (eventsForDay.length === 0) {
            eventsListEl.innerHTML = '<p style="text-align: center; opacity: 0.7; padding: 20px 0;">No lessons on this day.</p>';
            return;
        }
        eventsListEl.innerHTML = eventsForDay.map(event => `
            <div class="event-item">
                <div class="event-status-dot" style="background-color: ${event.backgroundColor};"></div>
                <div class="event-time">${new Date(event.start).toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' })}</div>
                <div class="event-title">${event.title}</div>
                ${event.url ? `<a href="${event.url}" class="btn-icon"><i class="icon-edit"></i></a>` : ''}
            </div>
        `).join('');
    }

    const calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'dayGridMonth',
        headerToolbar: false,
        dayCellDidMount: function(arg) {
            const dateStr = getLocalDateString(arg.date);
            const eventsOnDay = allEvents.filter(event => getLocalDateString(event.start) === dateStr);
            if (eventsOnDay.length > 0) {
                let dotsContainer = document.createElement('div');
                dotsContainer.className = 'fc-day-has-event-dots';
                const uniqueColors = [...new Set(eventsOnDay.map(e => e.backgroundColor))];
                uniqueColors.slice(0, 3).forEach(color => {
                    let dot = document.createElement('div');
                    dot.className = 'fc-day-has-event-dot';
                    dot.style.backgroundColor = color;
                    dotsContainer.appendChild(dot);
                });
                arg.el.querySelector('.fc-daygrid-day-frame').appendChild(dotsContainer);
            }
        },
        dateClick: function(info) {
            if (selectedDateEl) selectedDateEl.classList.remove('day-selected');
            info.dayEl.classList.add('day-selected');
            selectedDateEl = info.dayEl;
            renderEventsForDate(info.dateStr);
        }
    });

    const navContainer = document.createElement('div');
    navContainer.id = 'calendar-nav';
    navContainer.innerHTML = `
        <button id="cal-prev"><i class="icon-prev"></i></button>
        <h2 id="calendar-title"></h2>
        <button id="cal-next"><i class="icon-next"></i></button>
    `;
    calendarEl.parentNode.insertBefore(navContainer, calendarEl);
    
    const titleEl = document.getElementById('calendar-title');
    
    function updateTitle() {
        titleEl.innerText = calendar.view.title;
    }

    document.getElementById('cal-prev').addEventListener('click', () => { calendar.prev(); updateTitle(); });
    document.getElementById('cal-next').addEventListener('click', () => { calendar.next(); updateTitle(); });
    
    calendar.render();
    updateTitle();
});
</script>