<div class="container">
    <!-- Header Section -->
    <div class="referral-header">
        <div class="header-content">
            <div class="header-badge">
                <span class="badge-icon">🎯</span>
                <span class="badge-text">Referral Program</span>
            </div>
            <h1 class="main-title">Invite Friends & Earn Together</h1>
            <p class="main-subtitle">Share coding knowledge and get rewarded for growing our community</p>
        </div>
    </div>

    <!-- Stats Cards -->
    <div class="stats-section">
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon">📚</div>
                <div class="stat-number"><%= user.lessonsPaid || 0 %></div>
                <div class="stat-text">Your Lessons</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">👥</div>
                <div class="stat-number"><%= referredUsers.length %></div>
                <div class="stat-text">Friends Invited</div>
            </div>
            <% if (user.referredBy) { %>
            <div class="stat-card special">
                <div class="stat-icon">⭐</div>
                <div class="stat-number">1</div>
                <div class="stat-text">Invited by <%= user.referredBy.name %></div>
            </div>
            <% } %>
        </div>
    </div>

    <!-- Referral Link Section -->
    <div class="referral-link-section">
        <div class="link-header">
            <h2>Your Magic Link</h2>
            <p>Share this special link with friends to start earning together</p>
        </div>
        <div class="referral-link-wrapper" onclick="copyToClipboard()" title="Click to copy">
            <div class="link-icon">🔗</div>
            <div class="referral-link" id="referralLink"><%= referralLink.split('=')[1] || referralLink %></div>
            <div class="copy-indicator">
                <span class="copy-text">Click to copy</span>
                <span class="copy-success">Copied! ✨</span>
            </div>
        </div>
    </div>

    <!-- How It Works Section -->
    <div class="how-it-works">
        <div class="section-header">
            <h2>How It Works</h2>
            <p>Simple steps to start earning free lessons</p>
        </div>
        <div class="steps-container">
            <div class="step-card">
                <div class="step-number">1</div>
                <div class="step-icon">📤</div>
                <h3>Share Your Link</h3>
                <p>Send your unique referral link to friends who want to learn coding</p>
            </div>
            <div class="step-card">
                <div class="step-number">2</div>
                <div class="step-icon">🎁</div>
                <h3>Friend Gets Free Lesson</h3>
                <p>When they sign up, they receive 1 free lesson to get started</p>
            </div>
            <div class="step-card">
                <div class="step-number">3</div>
                <div class="step-icon">💎</div>
                <h3>You Earn Rewards</h3>
                <p>Get 1 free lesson when they make their first payment</p>
            </div>
            <div class="step-card bonus">
                <div class="step-number">🚀</div>
                <div class="step-icon">⭐</div>
                <h3>Bonus Reward</h3>
                <p>Extra lesson if they purchase 20+ lessons at once</p>
            </div>
        </div>
    </div>

    <!-- Earned Lessons Summary -->
    <% if (totalEarnedLessons > 0) { %>
    <div class="earned-lessons-section">
        <div class="section-header">
            <h2>Your Earned Lessons</h2>
            <p>Lessons you've earned through successful referrals</p>
        </div>
        <div class="earned-summary">
            <div class="earned-card">
                <div class="earned-icon">🎉</div>
                <div class="earned-number"><%= totalEarnedLessons %></div>
                <div class="earned-text">Total Earned Lessons</div>
                <div class="earned-note">1 lesson per referral's first payment + 1 bonus for 20+ lesson purchases</div>
            </div>
        </div>
    </div>
    <% } %>

    <!-- Referred Users Section -->
    <div class="referred-users-section">
        <div class="section-header">
            <h2>Your Coding Community</h2>
            <p>Friends you've invited to join the programming journey</p>
        </div>
        <div class="users-container">
            <% if (referredUsers.length > 0) { %>
                <div class="users-grid">
                    <% referredUsers.forEach(function(referredUser) { %>
                        <div class="user-card">
                            <div class="user-avatar">👤</div>
                            <div class="user-info">
                                <h4><%= referredUser.name %></h4>
                                <p class="user-email"><%= referredUser.email %></p>
                                <p class="user-date">Joined <%= referredUser.date_registered.toLocaleDateString() %></p>
                                <div class="user-status-info">
                                    <% if (referredUser.status === 'new') { %>
                                        <span class="status-badge new">New</span>
                                    <% } else { %>
                                        <span class="status-badge active"><%= referredUser.status %></span>
                                    <% } %>
                                    <% if (referredUser.earnedLessons > 0) { %>
                                        <span class="earned-badge">+<%= referredUser.earnedLessons %> lessons</span>
                                    <% } %>
                                </div>
                            </div>
                            <div class="user-status">✅</div>
                        </div>
                    <% }); %>
                </div>
            <% } else { %>
                <div class="empty-state">
                    <div class="empty-icon">🌟</div>
                    <h3>Start Building Your Community</h3>
                    <p>No friends invited yet. Share your link and watch your coding community grow!</p>
                    <button class="share-btn" onclick="copyToClipboard()">Share Your Link</button>
                </div>
            <% } %>
        </div>
    </div>
</div>

<script>
function copyToClipboard() {
    const copyText = document.querySelector('.copy-text');
    const copySuccess = document.querySelector('.copy-success');
    const wrapper = document.querySelector('.referral-link-wrapper');
    const fullReferralLink = '<%= referralLink %>';
    
    // Copy to clipboard using modern API
    if (navigator.clipboard && window.isSecureContext) {
        navigator.clipboard.writeText(fullReferralLink).then(() => {
            showCopySuccess();
        }).catch(() => {
            fallbackCopy();
        });
    } else {
        fallbackCopy();
    }
    
    function fallbackCopy() {
        const textArea = document.createElement('textarea');
        textArea.value = fullReferralLink;
        document.body.appendChild(textArea);
        textArea.select();
        document.execCommand('copy');
        document.body.removeChild(textArea);
        showCopySuccess();
    }
    
    function showCopySuccess() {
        // Hide copy text and show success message
        copyText.style.opacity = '0';
        copySuccess.style.opacity = '1';
        
        // Add success animation to wrapper
        wrapper.classList.add('copied');
        
        // Reset after 2 seconds
        setTimeout(() => {
            copyText.style.opacity = '1';
            copySuccess.style.opacity = '0';
            wrapper.classList.remove('copied');
        }, 2000);
    }
}
</script>